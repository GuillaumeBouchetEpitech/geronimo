class b{_textAreaElement;_lines;_maxLines;constructor(_){this._textAreaElement=_,this._textAreaElement.value="",this._lines=[],this._maxLines=30}log(..._){if(_.length==0)return;const J=Array.prototype.slice.call(_).join(" ");console.log(J),this._pushText(J)}error(..._){if(_.length==0)return;const J=Array.prototype.slice.call(_).join(" ");console.error(J),this._pushText(`[ERR] - ${J}`)}_pushText(_){if(this._lines.push(_),this._lines.length>this._maxLines)this._lines.splice(0,this._lines.length-this._maxLines);this._textAreaElement.value=`${this._lines.join("\n")}\n`,this._textAreaElement.scrollTop=this._textAreaElement.scrollHeight}get size(){return this._lines.length}peekLast(){if(this._lines.length>0)return this._lines[this._lines.length-1];return}popLast(){if(this._lines.length>0)this._lines.splice(this._lines.length-1,1)}}var G=b;var T=/[?&]+([^=&]+)=([^&]*)/gi,P=()=>{const _={};let J=null;while(J=T.exec(window.location.href)){const $=J[1],B=J[2];_[$]=B}return _};var S=(_)=>{return new Promise((J,$)=>{const B=document.createElement("script");B.src=_,B.addEventListener("load",()=>J()),B.addEventListener("error",(K)=>$(K)),document.head.appendChild(B)})};var I=(_)=>{if(!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsupported)");const J={alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1},$=_.getContext("webgl2",J);if(!$)throw new Error("WebGL2 context failed (initialization)");return $};var A=()=>{return(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)!==void 0};var W=()=>{return(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const J=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(J instanceof WebAssembly.Module)return new WebAssembly.Instance(J)instanceof WebAssembly.Instance}}catch(J){}return!1})()};var w=()=>{return!!window.Worker};var F=()=>{return!!window.WebGL2RenderingContext};var C=()=>{const _=window.SharedArrayBuffer!==void 0;if(_){const $={initial:8,maximum:8,shared:!0};if(!(new WebAssembly.Memory($).buffer instanceof SharedArrayBuffer))return!1}return _};class U{_canvas;_webglCtx;_width=800;_height=600;_isInitialized=!1;_isAborted=!1;_wasmApplicationStartFunc;_wasmApplicationUpdateFunc;_wasmApplicationRenderFunc;_onProgress;_onError;_module;constructor(_,J,$){this._canvas=_,this._onProgress=J,this._onError=$}async initialize(_,J,$){if(this._width=_,this._height=J,!w())throw new Error("missing WebWorker feature (unsupported)");if($.log("[JS][check] WebWorker feature => supported"),!W())throw new Error("missing WebAssembly feature (unsupported)");if($.log("[JS][check] WebAssembly feature => supported"),C())$.log("[JS][check] multithreading => supported");else $.log("[JS][check] multithreading => NOT supported");if(!F())throw new Error("missing WebGL2 feature (unsupported)");$.log("[JS][check] WebGL2 feature => supported");const B=()=>{if(this._isAborted=!0,this._onError)this._onError("Could not create a WebGL2 context.")};this._canvas.addEventListener("webglcontextcreationerror",B,!1);const K=()=>{if(this._isAborted=!0,this._onError)this._onError("WebGL2 context lost. You will need to reload the page.")};this._canvas.addEventListener("webglcontextlost",K,!1);const y=(X)=>{X.preventDefault()};this._canvas.addEventListener("contextmenu",y,!1),this._webglCtx=I(this._canvas),$.log("[JS] WebGL2 context initialized"),await this._setupWasmApplication($)}async _fetchWasmScript(_,J){J.log("[JS][wasm] fetching");const $=Date.now();await S(`./${_}/index.js`);const K=((Date.now()-$)/1000).toFixed(3);J.log(`[JS][wasm] fetched ${K}sec`)}async _loadWasmApplication(_,J){J.log("[JS] loading");const $=Date.now(),B=/Downloading data\.\.\. \(([0-9]*)\/([0-9]*)\)/;let K=0;const y={locateFile:(Q)=>`${_}/${Q}`,print:(Q)=>{J.log(`[C++][out] ${Q}`)},printErr:(Q)=>{J.error(`[C++][err] ${Q}`)},setStatus:(Q)=>{if(!Q)return;const Z=B.exec(Q);if(!Z){J.log(`[JS][wasm][status] ${Q}`);return}const k=parseFloat(Z[1]),H=parseFloat(Z[2]),z=Math.floor(k/H*100);if(K===z)return;K=z,this._onProgress(z)},onRuntimeInitialized:()=>{J.log("[JS][wasm] runtime initialized")},canvas:this._canvas,preinitializedWebGLContext:this._webglCtx,noInitialRun:!0,noExitRuntime:!0};this._module=await testBedApp(y);const D=((Date.now()-$)/1000).toFixed(3);J.log(`[JS] loaded ${D}sec`)}_initializeWasmApplication(_){_.log("[JS][wasm] initializing");const J=Date.now(),$={startApplication:this._module.cwrap("startApplication",void 0,["number","number"]),updateApplication:this._module.cwrap("updateApplication",void 0,["number"]),renderApplication:this._module.cwrap("renderApplication",void 0,[])};this._wasmApplicationStartFunc=$.startApplication,this._wasmApplicationUpdateFunc=$.updateApplication,this._wasmApplicationRenderFunc=$.renderApplication,this._isInitialized=!0;const K=((Date.now()-J)/1000).toFixed(3);_.log(`[JS][wasm] initialized ${K}sec`)}async _setupWasmApplication(_){await this._fetchWasmScript("wasm",_),await this._loadWasmApplication("wasm",_),this._initializeWasmApplication(_),_.log("[JS][wasm] running"),this._wasmApplicationStartFunc(this._width,this._height)}update(_){if(!this._isInitialized||this._isAborted||!this._wasmApplicationUpdateFunc)return;const J=A()?1:0;this._wasmApplicationUpdateFunc(_,J)}render(){if(!this._isInitialized||this._isAborted||!this._wasmApplicationRenderFunc)return;this._wasmApplicationRenderFunc()}abort(){if(!this._isInitialized||this._isAborted)return;this._isAborted=!0;const _=window.Module;if(_)_.setStatus=(J)=>{if(J)console.error(`[JS][wasm][aborted] ${J}`)}}}var j=(_)=>{const J=document.querySelector(_);if(!J)throw new Error(`DOM elements not found, id=${_}`);return J},v=async()=>{let _=!0;const J=j("#loggerOutput"),$=new G(J);$.log("[JS] page loaded");const B=(q)=>{_=!1,console.error("error event",q),$.error(`[JS] exception, event=${q}`)};window.addEventListener("error",B);const K=j("#errorText"),y=j("#renderArea"),X=j("#canvas"),D=(q)=>{if(q.style.display!=="none")q.style.display="none"},Q=(q)=>{if(q.style.display!=="block")q.style.display="block"},Z=(q)=>{K.innerHTML=q,D(X),Q(K)},k=()=>{D(K),Q(X)},H=(q,Y)=>{y.style.maxWidth=X.style.maxWidth=`${q}px`,y.style.maxHeight=X.style.maxHeight=`${Y}px`,X.width=q,X.height=Y},z=(q)=>{B(q),Z(`fatal error, event=${q}`)};window.removeEventListener("error",B),window.addEventListener("error",z);const R=(q,Y)=>q?parseInt(q,10):Y,f=P(),N={width:R(f.width,800),height:R(f.height,600)};H(N.width,N.height);const O=new U(X,(q)=>{const Y=`Loading wasm [${q}%]`;if($.size>0&&$.peekLast().indexOf("Loading wasm [")>=0)$.popLast();$.log(`[JS] ${Y}`),Z(Y)},Z);try{await O.initialize(N.width,N.height,$),k()}catch(q){$.error(`[JS] dependencies check failed: message="${q.message}"`),Z(["this browser isn't compatible","error message:",`=> ${q.message}`].join("<br>"))}let M=Date.now();const V=()=>{if(_)requestAnimationFrame(V);const q=Date.now(),Y=q-M;M=q,O.update(Y),O.render()};V()};window.addEventListener("load",v);
